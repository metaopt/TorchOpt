name: Wheel tests

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: "recursive"
          fetch-depth: 1

      - name: Set up Python 3.7
        id: py37
        uses: actions/setup-python@v4
        with:
          python-version: "3.7"
          update-environment: false

      - name: Set up Python 3.8
        id: py38
        uses: actions/setup-python@v4
        with:
          python-version: "3.8"
          update-environment: false

      - name: Set up Python 3.9
        id: py39
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"
          update-environment: false

      - name: Set up Python 3.10
        id: py310
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          update-environment: false

      - name: Set up Python executable paths
        run: |
          DEFAULT_PYTHON="${{ steps.py37.outputs.python-path }}"
          echo "DEFAULT_PYTHON='${DEFAULT_PYTHON}'" >> "${GITHUB_ENV}"

          PYTHON_EXECUTABLES="${{ steps.py37.outputs.python-path }}"
          PYTHON_EXECUTABLES="${PYTHON_EXECUTABLES}:${{ steps.py38.outputs.python-path }}"
          PYTHON_EXECUTABLES="${PYTHON_EXECUTABLES}:${{ steps.py39.outputs.python-path }}"
          PYTHON_EXECUTABLES="${PYTHON_EXECUTABLES}:${{ steps.py310.outputs.python-path }}"
          echo "PYTHON_EXECUTABLES='${PYTHON_EXECUTABLES}'" >> "${GITHUB_ENV}"

      - name: Check consistency between the package version and release tag
        run: |
          RELEASE_VER="${GITHUB_REF#refs/*/}"
          PACKAGE_VER="v$(python setup.py --version)"
          if [[ "${RELEASE_VER}" != "${PACKAGE_VER}" ]]; then
            echo "package ver. (${PACKAGE_VER}) != release ver. (${RELEASE_VER})"
            exit 1
          fi

      - name: Setup CUDA Toolkit
        uses: Jimver/cuda-toolkit@v0.2.7
        id: cuda-toolkit
        with:
          cuda: "11.6.2"
          method: network
          sub-packages: '["nvcc"]'
      - run: |
          echo "Installed CUDA version is: ${{steps.cuda-toolkit.outputs.cuda}}"
          echo "CUDA install location: ${{steps.cuda-toolkit.outputs.CUDA_PATH}}"
          nvcc -V

      - name: Build sdist and wheels
        run: |
          while IFS='' read -rd':' PYTHON || [[ -n "${PYTHON}" ]]; do
            [[ -z "${PYTHON}" ]] && continue
            echo "Building wheel with Python: ${PYTHON} ($("${PYTHON}" --version))"
            "${PYTHON}" -m pip install --upgrade pip setuptools wheel build
            if [[ "${PYTHON}" == "${DEFAULT_PYTHON}" ]]; then
              "${PYTHON}" -m build
            else
              "${PYTHON}" -m build --wheel
            fi
          done <<< "${PYTHON_EXECUTABLES}"

      - name: Test sdist and wheels
        run: |
          while IFS='' read -rd':' PYTHON || [[ -n "${PYTHON}" ]]; do
            [[ -z "${PYTHON}" ]] && continue
            PYVER="cp$("${PYTHON}" --version | cut -d ' ' -f2 | cut -d '.' -f-2 | tr -d '.')"
            mkdir -p "temp-${PYVER}"
            pushd "temp-${PYVER}"
            if [[ "${PYTHON}" == "${DEFAULT_PYTHON}" ]]; then
              echo "Testing sdist with Python: ${PYTHON} (${PYVER})"
              "${PYTHON}" -m pip uninstall torchopt -y
              "${PYTHON}" -m pip install ../dist/torchopt-*.tar.gz
              "${PYTHON}" -c 'import torchopt'
            fi
            echo "Testing wheel with Python: ${PYTHON} (${PYVER})"
            "${PYTHON}" -m pip uninstall torchopt -y
            "${PYTHON}" -m pip install ../dist/torchopt-${PYVER}-*.whl
            "${PYTHON}" -c 'import torchopt'
            "${PYTHON}" -m pip uninstall torchopt -y
            popd
          done <<< "${PYTHON_EXECUTABLES}"

      - name: Publish to PyPI Test
        env:
          TWINE_USERNAME: "__token__"
          TWINE_PASSWORD: ${{ secrets.PYPI_UPLOAD_TOKEN }}
        run: |
          "${DEFAULT_PYTHON}" -m pip install --upgrade twine
          "${DEFAULT_PYTHON}" -m twine upload --repository testpypi dist/*
